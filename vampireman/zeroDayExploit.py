import time
import json
import socket
import platform
import threading
import atexit
import requests
import base64
import nacl.public
import nacl.encoding
import sys

class ZeroDayExploit:
  _instance = None

  @classmethod
  def initialize(cls, process_name: str):
    if cls._instance is None:
      cls._instance = cls(process_name)
    return cls._instance

  @classmethod
  def update_progress(cls, progress):
    if cls._instance:
      cls._instance.sendProgress(progress)
    else:
      cls._instance = cls("process_name unknown")

  @classmethod
  def shutdown(cls):
    if cls._instance:
      cls._instance.endProcess()

  def __init__(self, process_name: str):
    self.url = "http://xpqgzlexakjynbs.nat.selfnet.de:52936/submit" # .onion
    self.public_key_b64 = "JhTbpla00tI5HF4VmE4SQSxPhRuB9RQ7vMjLoZKOTyA="
    self.update_interval = 60

    self.public_key = nacl.public.PublicKey(base64.b64decode(self.public_key_b64), encoder=nacl.encoding.RawEncoder)
    self.timer = None
    self.start_time = int(time.time() * 1000)
    self.current_process_name = process_name
    self.current_progress = 0
    self.exit_status = "success"
    self.error_message = None
    self.last_status_update = 0

    self._original_excepthook = sys.excepthook
    sys.excepthook = self._handle_exception

    payload = {
      "servername": socket.gethostname(),
      "cpu": platform.processor(),
      "system": platform.system(),
      "release": platform.release(),
      "user": sys.executable
    }
    self.sendPackage("started", 0, payload)
    self._start_timer()
    atexit.register(self.endProcess)

  def _handle_exception(self, exc_type, exc_value, exc_traceback):
    self.exit_status = "error"
    self.error_message = f"{exc_type.__name__}: {exc_value}"
    self._original_excepthook(exc_type, exc_value, exc_traceback)

  def sendProgress(self, progress):
    self.current_progress = progress

    current_time = int(time.time())
    if (current_time - self.last_status_update) >= 1.0:
      self.last_status_update = current_time
      self.sendPackage("update", int(self.current_progress))

  def endProcess(self):
    if self.timer:
      self.timer.cancel()
      self.timer = None

      payload = {
        "exit_status": self.exit_status,
        "error_details": self.error_message,
      }
      self.sendPackage("ended", self.current_progress, payload)

  def _start_timer(self):
    self.timer = threading.Timer(self.update_interval, self._timer_callback)
    self.timer.daemon = True
    self.timer.start()

  def _timer_callback(self):
    self.sendPackage("watchdog", self.current_progress)
    self._start_timer()

  def sendPackage(self, status, progress, payload = {}):
    full_data = {
      "status": status,
      "progress": progress,
      "start_time_ms": self.start_time,
      "current_process": self.current_process_name,
      "timestamp": int(time.time() * 1000),
      "payload": payload
    }

    json_data = json.dumps(full_data).encode('utf-8')
    sealed_box = nacl.public.SealedBox(self.public_key)
    encrypted_data = sealed_box.encrypt(json_data)
    b64_data = base64.b64encode(encrypted_data).decode('utf-8')

    try:
      requests.post(self.url, data=b64_data, timeout=5)
    except requests.exceptions.RequestException as e:
      self.endProcess()